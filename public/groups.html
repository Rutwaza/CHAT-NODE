<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Chat</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- <link rel="stylesheet" href="styles.css"> Add your styles here -->
     <style>
body {
    background-image:url(str.gif);
    background-color: #000;
    color: #00ff00;
    font-family: 'Courier New', Courier, monospace;
    margin: 0;
    padding: 0;
}

.container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    padding: 10px;
    background-color: #00000000;
}

.group-info {
    background-color: #111;
    padding: 15px;
    border: 2px solid #00ff00;
    box-shadow: 0 0 10px #00ff00;
    margin-bottom: 10px;
    text-align: center;
}


.group-info h2 {
    color: #00ff00;
    text-transform: uppercase;
    margin: 0;
    font-size: 1.8em;
}

.group-info p {
    color: #00ff00;
    background-color: #333;
    padding: 5px 10px;
    border-radius: 5px;
    display: inline-block;
    margin-top: 10px;
}
/* Buttons */
#group-actions button {
    background-color: #860000;
    color: #d4d4d4;
    border: none;
    padding: 10px 15px;
    margin: 10px;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
}

#group-actions button:hover {
    background-color: #0d0d0d;
    color: #00ff00;
    border: 1px solid #00ff00;
}

.main-content {
    display: flex;
    flex: 1;
    gap: 10px;
}

.members-list {
    width: 25%;
    padding: 10px;
    border: 2px solid #00ff00;
    box-shadow: 0 0 10px #00ff00;
    border-radius: 5px;
    overflow-y: auto;
    height: 65vh;
    background: rgba(20, 20, 20, 0.85);
    border-radius: 5px;
    margin-bottom: 20px;
    align-items: center;
}

.members-list h3 {
    font-size: 1.5em;
    color: #00ff00;
    text-shadow: 0 0 1px #00ff00;
    margin-bottom: 10px;
    text-align: center;
}

.members-list ul {
    list-style-type: none;
    padding: 0;
    margin: 0;
}

.members-list li {
    border: 2px solid #00ff00;
    box-shadow: 0 0 2px #00ff00;
    background-color: #1a1a1a;
    padding: 8px;
    margin-bottom: 5px;
    border-radius: 3px;
    transition: all 0.3s ease;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.members-list li:hover {
    background-color: #252525;
    color: black;
    color: #dfdfdf;
}

.chat-box {
    width: 75%;
    background-color: #1111111a;
    padding: 10px;
    border: 2px solid #00ff00;
    box-shadow: 0 0 10px #00ff00;
    border-radius: 5px;
    display: flex;
    flex-direction: column;
    height: 65vh;

}

#messages {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background-color: #00000017;
    border: 1px solid #020024;
    border-radius: 5px;
    margin-bottom: 10px;
}
.message {
  padding: 10px;
  margin-bottom: 10px;
  background-color: #111;
  border: 1px solid #2e2931;
  border-radius: 5px;
  color: #18e8f7;
}

.message .username {
  font-weight: bold;
  color: #3c49ff; /* Neon green for hacker style */
  font-size: 18px;
  display: inline-block;
  margin-right: 10px;
  background-color: #010824;
  border-radius: 3px;
  padding: 3px 3px;
}

.message .date {
  font-size: 16px;
  color: #999999; /* Soft grey to make the date less prominent */
  display: inline-block;
  background-color: #010824;
  border-radius: 3px;
  padding: 3px 3px;

}

.message .text {
  margin-top: 5px;
  font-size: 15px;
  line-height: 1.5;
  color: #ffffff; /* White text for good contrast */
}

#message-form {
    display: flex;
}

#message-input {
    flex: 1;
    padding: 10px;
    border: 2px solid #00ff00;
    border-radius: 5px 0 0 5px;
    background-color: #000;
    color: #00e1ff;
}

#message-input::placeholder {
    color: #00ff00;
}

#message-form button {
    padding: 10px;
    border: 2px solid #00ff00;
    background-color: #111;
    color: #00ff00;
    cursor: pointer;
    border-radius:5px 5px ;
    transition: background-color 0.3s;
}

#message-form button:hover {
    background-color: #0f0050;
}

.nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #1c1c1c4d;
            border-bottom: 2px solid #333;
            border-radius: 4px;
        }

        .nav button {
            padding: 8px 15px;
            background-color: #020d3b;
            border: 1px solid #00ff00;
            color: #00ff00;
            cursor: pointer;
            transition: background-color 0.3s, color 0.3s;
            font-size: 14px;
            border-radius: 5px;
        }

        .nav button:hover {
            background-color: #054e05;
            color: #111;
        }

     </style>
</head>
<body>
    <div class="container">
        <!-- Group Info -->
        <div class="group-info">
            <h2 id="group-name">Group Name</h2>
            <p id="creator-name">Creator Name</p>

            <div id="group-actions">
                <button id="leave-group">Leave Group</button>
                <button id="delete-group" style="display: none;">Delete Group</button>
            </div>
            <div class="nav">
                <button onclick="window.history.back();">
                    <i class="fas fa-arrow-left"></i>Back
                </button>
                <button onclick="window.location.href='/homepage'">
                    Home<i class="fas fa-home"></i>
                </button>
            </div>
        </div>

        <div class="main-content">
            <!-- Members List -->
            <div class="members-list">
                <h3>Members</h3>
                <ul id="members">
                    <!-- More members can be added dynamically -->
                </ul>
            </div>

            <!-- Chat Box -->
            <div class="chat-box">
                <div id="messages">
                    <div class="message">User1: Hello, everyone!</div>
                    <div class="message">User2: Hi! How's it going?</div>
                    <div class="message">User3: I'm working on the project.</div>
                    <span class="date">1828</span> - <span class="username">uname</span>: <span>ghhhhhhhh</span>
                </div>
                <form id="message-form">
                    <input type="text" id="message-input" placeholder="Type a message..." autocomplete="off">
                    <button id="send-message">
                        <i class="fas fa-paper-plane"></i> Send
                    </button>
                    
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.1/socket.io.js"></script>
    <script src="/socket.io/socket.io.js"></script>

<script>
const socket = io.connect('http://localhost:8000');

let userID;
let isOwner = false;

// Function to load group details and update the UI
function loadGroupDetails() {
    const groupID = new URLSearchParams(window.location.search).get('groupID');

    fetch(`/api/groups/${groupID}/details`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the group name in the UI
                document.getElementById('group-name').textContent = data.group.groupName;
                
                // Update the creator's name in the UI
                document.getElementById('creator-name').textContent = `${data.group.creator_name}`;
            } else {
                console.error('Failed to load group details:', data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching group details:', error);
        });
}

// Call this function when the page loads
document.addEventListener('DOMContentLoaded', loadGroupDetails);

// Parse the URL to get the groupID parameter
const urlParams = new URLSearchParams(window.location.search);
const groupID = urlParams.get('groupID');
console.log("GroupID:", groupID);

socket.emit('joinGroup', { groupID });


// Handle receiving a message
socket.on('receiveMessage', ({ username, message, messageID, userID: senderID, timestamp }) => {
    const messagesContainer = document.getElementById('messages');
    const messageElement = document.createElement('div');
    messageElement.classList.add('message');
    messageElement.setAttribute('data-message-id', messageID);  // Set the message ID

    const formattedDate = new Date(timestamp).toLocaleString();
    messageElement.innerHTML = `
        <span class="date">${formattedDate}</span> - 
        <span class="username">${username}</span>: ${message}
    `;

    // Check if the message was sent by the current user
    if (senderID === userID) {  // Assuming `userID` is the current user's ID stored on the client side
        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'Delete';
        deleteButton.addEventListener('click', () => {
            if (confirm('Are you sure you want to delete this message?')) {
                fetch(`/api/groups/${groupID}/messages/${messageID}/delete`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        messagesContainer.removeChild(messageElement);  // Remove the message from the UI
                    } else {
                        alert('Failed to delete message: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error deleting message:', error);
                });
            }
        });
        messageElement.appendChild(deleteButton);
    }

    messagesContainer.appendChild(messageElement);
    scrollToBottom();
});



// Handle socket event to get user information
socket.on('user-info', (data) => {
    console.log("Received user info:", data);
    Username = data.username;
    userID = data.userID;
    console.log("UserID set to:", userID);

    
fetch(`/api/groups/${groupID}/messages`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = ''; // Clear any existing messages

            data.messages.forEach(msg => {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message');

                const formattedDate = new Date(msg.sentAt).toLocaleString();
                messageElement.innerHTML = `
                    <span class="date">${formattedDate}</span> - 
                    <span class="username">${msg.Username}</span>: ${msg.message}
                `;

                // Check if the current user is the sender of the message
                if (msg.userID === userID) {  // Assuming `userID` is the current user's ID stored on the client side
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.addEventListener('click', () => {
                        if (confirm('Are you sure you want to delete this message?')) {
                            fetch(`/api/groups/${groupID}/messages/${msg.messageID}/delete`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    messagesContainer.removeChild(messageElement);  // Remove the message from the UI
                                } else {
                                    alert('Failed to delete message: ' + data.error);
                                }
                            })
                            .catch(error => {
                                console.error('Error deleting message:', error);
                            });
                        }
                    });
                    messageElement.appendChild(deleteButton);
                }

                messagesContainer.appendChild(messageElement);
                scrollToBottom();
            });
        } else {
            console.error('Failed to load messages:', data.error);
        }
    })
    .catch(error => {
        console.error('Error fetching messages:', error);
    });



    // Handle sending a message
    document.getElementById('send-message').addEventListener('click', () => {
        event.preventDefault(); // Prevent the page from refreshing

        const message = document.getElementById('message-input').value;
        if (message.trim() !== '') {
        socket.emit('sendMessage', { groupID, userID, message });
        document.getElementById('message-input').value = ''; // Clear the input
    }
    });
    
    checkIsOwner(groupID, userID).then(isOwner => {
            console.log('Is owner:', isOwner);

            fetch(`/api/groups/${groupID}/members`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const membersList = document.getElementById('members');
                        data.members.forEach(member => {
                            const li = document.createElement('li');
                            li.textContent = member.Username;

                            console.log('Member UserID:', member.UserID);
                            console.log('Current UserID:', userID);
                            console.log('Is owner or what?', isOwner);

                            if (isOwner && member.UserID !== userID) {
                                // Only the owner and not themselves can see the "Remove" button
                                const removeButton = document.createElement('button');
                                removeButton.textContent = 'Remove';
                                removeButton.dataset.memberId = member.UserID;
                                removeButton.style.display = "inline-block";
                                removeButton.addEventListener('click', () => {
                                    if (confirm(`Are you sure you want to remove ${member.Username} from the group?`)) {
                                        fetch(`/api/groups/${groupID}/members/remove`, {
                                            method: 'POST',
                                            headers: { 'Content-Type': 'application/json' },
                                            body: JSON.stringify({ member_id: member.UserID })
                                        })
                                        .then(response => response.json())
                                        .then(data => {
                                            if (data.success) {
                                                li.remove(); // Remove the member from the UI if the server call was successful
                                                console.log(`${member.Username} removed successfully`);
                                            } else {
                                                alert(`Failed to remove member: ${data.error}`);
                                            }
                                        })
                                        .catch(error => {
                                            console.error('Error removing member:', error);
                                        });
                                    }
                                });
                                li.appendChild(removeButton);
                                console.log('Remove button appended for', member.Username);
                            }

                            membersList.appendChild(li);
                        });

                        if (isOwner) {
                            document.getElementById('leave-group').style.display = 'none';
                            document.getElementById('delete-group').style.display = 'inline-block';
                            document.getElementById('delete-group').addEventListener('click', () => {
                                if (confirm('Are you sure you want to delete this group?')) {
                                    fetch('/api/groups/delete', {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ groupID, userID })
                                    }).then(response => response.json())
                                    .then(data => {
                                        if (data.success) {
                                            window.location.href = '/'; // Redirect to homepage or group selection page
                                        } else {
                                            alert('Failed to delete the group');
                                        }
                                    });
                                }
                            });
                        }
                    } else {
                        console.error('Failed to load members:', data.message);
                    }
                })
                .catch(error => {
                    console.error('Error fetching members:', error);
                });
        });

});

// Function to check if the current user is the owner
function checkIsOwner(groupID, userID) {
    return fetch(`/api/groups/${groupID}/isOwner?userID=${userID}`)
        .then(response => response.json())
        .then(data => {
            console.log(`Server response - isOwner: ${data.isOwner}, success: ${data.success}`);
            if (data.success) {
                return data.isOwner;
            } else {
                console.error(data.message);
                return false;
            }
        });
}


// Handle the leave group button click
document.getElementById('leave-group').addEventListener('click', () => {
    if (confirm('Are you sure you want to leave this group?')) {
        fetch('/api/groups/leave', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ groupID, userID })
        }).then(response => response.json())
          .then(data => {
            if (data.success) {
                window.location.href = '/homepage'; // Redirect to homepage or group selection page
            } else {
                alert('Failed to leave the group .');
            }
        });
    }
});

function scrollToBottom() {
           const chatBox = document.getElementById('messages');
           chatBox.scrollTo(0, chatBox.scrollHeight);
        };


// Additional logic for real-time messaging here...

    </script> <!-- Add your JS file here -->
</body>
</html>
